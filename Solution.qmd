---
title: "Solution - Assessment 02"
author: "Calle Chambe, Calle Ontaneda, Chero Villegas, Poma Huamán, Sánchez Vásquez"
format: html
editor: visual
---

# Parte I

## 1. Explique con sus propias palabras, ¿la población objetivo es igual a la población marco? ¿Por qué? ¿Por qué no? Utilice ejemplos no discutidos en clase.

No, porque la población objetivo son todas las unidades que se quiere estudiar; mientras que la población marco es un conjunto accesible de la población objetivo que tienen $P(\text{selección}) > 0$ en la muestra.

Ejemplo 1: Encuesta de satisfacción a los clientes de Yape.

-   Población objetivo: Todos los usuarios de Yape.
-   Población marco: Todos los usuarios de Yape con correo electrónico activo.

Ejemplo 2: Encuesta de satisfacción de hogares que tienen servicio de internet.

-   Población objetivo: Todos los hogares del Perú que tienen servicio de internet.
-   Población marco: Todos los hogares con servicio de internet registradas en las empresas proveedoras.

## 2. Explique con sus propias palabras las diferencias entre dominio y estrato. Utilice ejemplos no discutidos durante las clases teóricas.

| Dominio | Estrato |
|------------------------------------|------------------------------------|
| Subdivisión de la población con resultados desagregados | Subconjunto de la población que, en el ideal, son homogéneos por dentro y heterogéneos entre sí |
| Permite estimaciones específicas | Mejora la precisión del muestreo, permite estimar de forma más precisa y reducir costos |
| Suele coincidir con áreas político-administrativas | No necesariamente coincide con áreas político-administrativas |

Ejemplo 1: Distinguir según niveles de ingreso

-   Dominio: Regiones del país
-   Estrato: Alto, Medio Alto, Medio, Medio Bajo y Bajo

Ejemplo 2: Evaluar el acceso a servicios de salud

-   Dominio: Tipos de establecimiento (Hospital, centro de salud, posta)
-   Estrato: Grupos etarios (infantes, niños, adultos, adultos mayores)

# Parte II

## 1. Utilice el Censo Nacional de Población y Vivienda 2017, filtrado para Lima Metropolitana que se ha subido a la carpeta de datos

```{r}
# Cargamos librerías
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(arrow, dplyr, survey)
```

```{r}
# Utilizamos el Censo 2017 filtrado a Lima Metropolitana desde la carpeta de datos
censo_2017 <- read_parquet("C:/Users/Hugo Jazyel/OneDrive/INEI/PEU-CD/Cursos especializados/4. Métodos de Estimación Estadística/Prácticas dirigidas/Datos/cpv2017_pob 1214 Lima.parquet")
```

## 2. Genere una variable dicotómica con el valor de 1 para quienes trabajan, y 0 para el resto de los casos. Llamar a esta variable “trabaja”

```{r}
# Generamos la variable 'trabaja' (1 = trabaja, 0 = no trabaja) a partir de 'c5_p16' (factor/ordenado)
censo_2017 <- censo_2017 |>
  mutate(
    trabaja = case_when(
      tolower(as.character(c5_p16)) %in% c("si, trabajó por algún pago") ~ 1,
      tolower(as.character(c5_p16)) %in% c("no, trabajó por algún pago") ~ 0,
      TRUE ~ NA_real_
    )
  )
```

## 3. Genere una variable numérica de la edad a partir de la variable “c5_p4_1” y llame a esta variable “edad”

```{r}
# Generamos 'edad' a partir de 'c5_p4_1' (factor/ordenado)
censo_2017 <- censo_2017 |>
  mutate(edad = if (is.numeric(c5_p4_1)) c5_p4_1 else
           suppressWarnings(as.numeric(gsub("[^0-9]", "", c5_p4_1))))
```

## 4. Genere los grupos de edad “Menores de 15 años”, “15 a 30 años”, “30 a 65 años” y “Más de 65 años”. Llame a esta variable “grupo_edad”

```{r}
# Generamos 'grupo_edad' con 4 cortes (intervalos [a,b))
censo_2017 <- censo_2017 |>
  mutate(
    grupo_edad = cut(
      edad,
      breaks = c(-Inf, 15, 30, 65, Inf),
      labels = c("Menores de 15", "15 a 29", "30 a 64", "65 a más"),
      right  = FALSE,
      ordered_result = TRUE
    )
  )
```

## 5. Establezca una semilla (“seed”) usando los cuatro dígitos del año actual

```{r}
set.seed(2025)
```

## 6. Realice un muestreo estratificado para cada grupo de edad de la variable “trabaja”

```{r}
# Definimos el marco (considerando todas las edades y manteniendo NA como NA)
base_all <- censo_2017

# Calculamos tamaños poblacionales por estrato y total
Nh_tab  <- table(base_all$grupo_edad)                 # N_h por grupo
niveles <- levels(na.omit(base_all$grupo_edad))
N       <- sum(Nh_tab)

# Fijamos precisión y calculamos n por SRS usando la varianza observada s^2
z <- 1.96   # 95% de confianza
e <- 0.03   # 3 puntos porcentuales (para mayor precisión)
p_hat <- mean(base_all$trabaja, na.rm = TRUE)
s2    <- p_hat * (1 - p_hat)                          # varianza observada de 'trabaja'

n0      <- (z^2 * s2) / (e^2)                         # SRS sin FPC
n_total <- ceiling(n0 / (1 + (n0 - 1) / N))           # aplicamos FPC y redondeamos

# Asignamos proporcional: n_h = n_total * (N_h / N) y ajustamos por redondeo
prop_h  <- as.numeric(Nh_tab[niveles]) / N
nh_raw  <- n_total * prop_h
nh      <- floor(nh_raw)
faltan  <- n_total - sum(nh)
if (faltan > 0) {
  ord <- order(nh_raw - nh, decreasing = TRUE)
  nh[ord[seq_len(faltan)]] <- nh[ord[seq_len(faltan)]] + 1
}
names(nh) <- niveles

# Seleccionamos sin reemplazo dentro de cada estrato
idx_list <- lapply(niveles, function(g) which(base_all$grupo_edad == g)); names(idx_list) <- niveles
idx_m    <- unlist(mapply(function(idx, nn) if (nn > 0) sample(idx, nn) else integer(0),
                          idx_list, nh, SIMPLIFY = FALSE), use.names = FALSE)

# Construimos la muestra y añadimos FPC por estrato (N_h)
m_estrat <- base_all[idx_m, , drop = FALSE] |>
  dplyr::mutate(fpc = as.numeric(Nh_tab[as.character(grupo_edad)]))
```

## 7. Declare el diseño muestral (completo) y obtenga las siguientes estadísticas (deben ser representativas):

### a. El porcentaje de personas que trabajan para cada grupo de edad en Lima Metropolitana

```{r}
# Declaramos el diseño estratificado con FPC y estimamos el % que trabaja por grupo
dis_prop <- survey::svydesign(ids = ~1, strata = ~grupo_edad, fpc = ~fpc, data = m_estrat)

res_pct_grupo <- survey::svyby(~trabaja, ~grupo_edad, dis_prop, survey::svymean, na.rm = TRUE)

out_pct <- res_pct_grupo |>
  as.data.frame() |>
  dplyr::transmute(
    grupo_edad,
    pct_trabaja = trabaja * 100,
    se_pct      = se * 100
  )

# Mostramos tabla de asignación utilizada y resultados
tabla_nh <- data.frame(
  estrato = names(nh),
  N_h     = as.integer(Nh_tab[names(nh)]),
  n_h     = as.integer(nh),
  prop_h  = round(100 * as.numeric(Nh_tab[names(nh)]) / N, 2),
  row.names = NULL
)
print(tabla_nh)
print(out_pct)
```

### b. El total de personas que trabajan en Lima Metropolitana

```{r}
# Para el total poblacional que trabaja, declaramos diseño con pesos w_h = N_h / n_h
w_tab <- as.numeric(Nh_tab[niveles] / nh[niveles]); names(w_tab) <- niveles
m_estrat_w <- dplyr::mutate(m_estrat, w = w_tab[as.character(grupo_edad)])

dis_prop_w <- survey::svydesign(ids = ~1, strata = ~grupo_edad, weights = ~w, data = m_estrat_w)
res_total  <- survey::svytotal(~trabaja, dis_prop_w, na.rm = TRUE)

out_total <- data.frame(
  total_trabaja = as.numeric(coef(res_total)),
  se_total      = as.numeric(SE(res_total))
)

# Mostramos resultados
print(out_total)
```

## 8. Calcule el efecto de diseño (deff) respecto a un MAS para ambas estimaciones. Comente

```{r}
# Calculamos el DEFF de 7a: porcentaje que trabaja por estrato (usamos dis_prop con FPC)
deff_por_grupo <- sapply(niveles, function(g) {
  est_g <- survey::svymean(~trabaja,
                           subset(dis_prop, grupo_edad == g),
                           na.rm = TRUE, deff = "srs")
  tryCatch(as.numeric(survey::deff(est_g)), error = function(e) NA_real_)
})

# Armamos la tabla de deff por estrato (7a)
deff_tab_7a <- data.frame(
  grupo_edad = factor(names(deff_por_grupo), levels = niveles, ordered = TRUE),
  deff       = as.numeric(deff_por_grupo),
  row.names  = NULL
)

# Calculamos el DEFF de 7b: total de personas que trabajan (usamos dis_prop_w con pesos)
res_total_deff <- survey::svytotal(~trabaja, dis_prop_w, na.rm = TRUE, deff = "srs")
deff_total     <- as.numeric(survey::deff(res_total_deff))

deff_tab_7b <- data.frame(
  estimacion = "Total de personas que trabajan",
  deff       = deff_total
)

# Mostramos resultados (7a por estrato y 7b total)
print(deff_tab_7a)  # deff por estrato (7a)
print(deff_tab_7b)  # deff global del total (7b)

```

Los resultados obtenidos permiten analizar el efecto de diseño en ambas estimaciones y valorar la eficiencia del muestreo aleatorio estratificado (MAE) proporcional respecto a un muestreo aleatorio simple (MAS) de igual tamaño. En primer lugar, para el porcentaje de personas que trabajan por grupo de edad, los valores del deff se aproximan a uno en todos los estratos. En los grupos de 15 a 29, 30 a 64 y 65 años a más el deff es exactamente igual a 1, mientras que en el grupo de menores de 15 alcanza un valor de 0.9978. Este comportamiento confirma que, dentro de cada estrato, el diseño se comporta prácticamente como un muestreo aleatorio simple con corrección por población finita, lo cual guarda coherencia con la propiedad de inocuidad del diseño, según la cual el muestreo aleatorio estratificado es al menos igual de eficiente que el muestreo aleatorio simple bajo el mismo tamaño muestral. En consecuencia, las varianzas bajo el diseño MAE y bajo el MAS resultan prácticamente equivalentes, aunque las pequeñas desviaciones de la unidad, como el 0.9978 en el primer grupo etario, evidencian una ligera ganancia que introduce el factor de corrección por población finita en el MAE.

Por otra parte, al examinar el deff correspondiente al total de personas que trabajan en Lima Metropolitana, se obtiene un valor de 0.7757. Este resultado evidencia una ganancia de eficiencia del MAE respecto al MAS, ya que la varianza del estimador total bajo el diseño estratificado es aproximadamente un 22% menor que la que se obtendría en un MAS de igual tamaño. En términos del error estándar, la mejora equivale a una reducción cercana al 12%. Este efecto se debe a que, al combinar los estratos definidos por grupos de edad, el diseño logra aprovechar la heterogeneidad existente entre ellos, lo cual reduce la variabilidad global del estimador. Dicho de otro modo, aunque dentro de cada estrato el diseño se comporte de manera similar al MAS, la estructura estratificada permite una mayor precisión en la estimación del total al ponderar adecuadamente los grupos con diferentes proporciones de personas que trabajan.

En conjunto, los resultados confirman que el muestreo aleatorio estratificado proporcional mantiene una eficiencia equivalente a la del MAS en las estimaciones dentro de los estratos, pero ofrece una ventaja clara cuando el interés se centra en parámetros globales. En este caso, el valor de deff menor que uno para el total de personas que trabajan demuestra que el diseño implementado es más eficiente que un muestreo simple del mismo tamaño, lo cual valida la pertinencia del procedimiento aplicado y la consistencia metodológica de los resultados obtenidos.

# Parte III

# 1. Diseño muestral de la Encuesta Nacional sobre Relaciones Sociales (ENARES 2024)

La Encuesta Nacional sobre Relaciones Sociales (ENARES 2024) es un estudio estadístico de carácter probabilístico y representativo a nivel nacional y departamental, orientado a generar información sobre los distintos tipos de violencia (física, psicológica y sexual) en mujeres, hombres, niñas, niños y adolescentes.

En la ENARES 2024, se implementaron cuatro encuestas:

-   **CRS.01:** Dirigida a mujeres de 18 años a más

-   **CRS.02:** Dirigida a hombres y mujeres de 18 años a más

-   **CRS.03:** Dirigida a niñas y niños de 9 a 11 años

-   **CRS.04:** Dirigida a adolescentes de 12 a 17 años

## 1.1. Encuesta en viviendas

### 1.1.1. Marco muestral

El marco de selección de la ENARES 2024 proviene de la cartografía y base estadística de los Censos Nacionales 2017: XII de Población, VII de Vivienda y III de Comunidades Indígenas.\
Este marco proporciona la delimitación territorial y la relación actualizada de viviendas particulares ocupadas, diferenciadas por área urbana y rural, garantizando cobertura y consistencia en los dominios de inferencia.

### 1.1.2. Unidades de muestreo

El procedimiento muestral en viviendas se desarrolla en cuatro etapas:

-   Unidad Primaria de Muestreo (UPM):
    -   En el área urbana: conglomerado, conformado por una o más manzanas contiguas que en promedio agrupan 140 viviendas.
    -   En el área rural: la UPM puede corresponder a un conglomerado rural o a un Área de Empadronamiento Rural (AER), con aproximadamente 100 viviendas.
-   Unidad Secundaria de Muestreo (USM): viviendas particulares dentro de las UPM seleccionadas.
-   Unidad Terciaria de Muestreo (UTM): hogar seleccionado dentro de la vivienda.
-   Unidad Cuarta de Muestreo (UCM): persona seleccionada dentro del hogar (según población objetivo).

### 1.1.3. Tipo de muestreo

El diseño de la encuesta es probabilístico, estratificado, por áreas y multietápico, con independencia entre departamentos. Las etapas de selección se desarrollan de la siguiente manera:

1.  Primera etapa: selección sistemática de UPM con probabilidad proporcional al tamaño (PPT).
2.  Segunda etapa: selección sistemática simple de viviendas.
3.  Tercera y cuarta etapa: selección aleatoria simple de hogares y personas.

Asimismo, el diseño garantiza un nivel de confianza del 95% y un efecto de diseño (DEFF) de 1.2, considerando un ajuste por tasa de no respuesta (TNR).

### 1.1.4. Cálculo del tamaño muestral

Por su parte, el tamaño de muestra por departamento se determinó considerando el nivel de confianza, la variabilidad esperada del fenómeno, el margen de error permitido, la tasa de no respuesta y el efecto de diseño.\
En este marco, el número de entrevistas se calculó con la siguiente expresión:

$$
n = \frac{Z^2pqN}{d^2(N - 1) + Z^2pq} \times DEFF \times \frac{1}{(1 - TNR)}
$$

Donde:

-   *n* = tamaño muestral requerido en cada departamento
-   *Z* = valor de la distribución normal (1.96 para 95% de confianza)
-   *p* = proporción esperada del atributo en la población
-   *q = 1 - p*
-   *N* = tamaño poblacional del departamento
-   *d* = margen de error
-   *DEFF* = efecto de diseño (1.2
-   *TNR* = tasa de no respuesta

Para cada dominio departamental se ajustaron los valores de los parámetros según la confiabilidad estadística y las prevalencias previas de la ENARES 2019.

**Distribución de la muestra por tipo de encuesta y área:**

| Tipo de encuesta                            |  Total | Urbana | Rural |
|---------------------------------------------|-------:|-------:|------:|
| Mujeres de 18 años a más (CRS.01)           | 14,858 | 10,586 | 4,272 |
| Hombres y mujeres de 18 años a más (CRS.02) |  9,556 |  6,796 | 2,760 |

**Total:** 24,414 entrevistas en viviendas particulares a nivel nacional.

### 1.1.5. Nivel de inferencia

El diseño muestral permite realizar inferencias a nivel nacional y departamental. Para el caso del departamento de Lima, se establecieron tres dominios:

1.  Provincia Constitucional del Callao
2.  Lima Metropolitana, que comprende los 43 distritos de la provincia de Lima
3.  Región Lima, conformada por las provincias de Barranca, Cajatambo, Canta, Cañete, Huaral, Huarochirí, Huaura, Oyón y Yauyos

## 1.2. Encuesta en instituciones educativas

### 1.2.1. Marco muestral

El marco muestral para las encuestas escolares proviene del Padrón Nacional de Instituciones Educativas (MINEDU), que incluye la información actualizada de instituciones educativas activas de los niveles primario y secundario, tanto públicas como privadas. Este marco se organizó por departamento y área geográfica (urbana y rural), considerando el número de alumnos matriculados como medida del tamaño de la unidad primaria.

### 1.2.2. Unidades de muestreo

El proceso de selección en instituciones educativas comprende tres niveles:

-   Unidad Primaria de Muestreo (UPM): institución educativa.
-   Unidad Secundaria de Muestreo (USM): secciones de aula (4.º, 5.º y 6.º de primaria; 1.º a 5.º de secundaria).
-   Unidad Terciaria de Muestreo (UTM): alumnos seleccionados dentro de las secciones.

**Número de alumnos seleccionados por institución:**

| Población objetivo | Alumnos por institución: Urbana | Alumnos por institución: Rural |
|------------------------|-----------------------:|-----------------------:|
| Niñas y niños de 9 a 11 años | 18 | 10 |
| Adolescentes de 12 a 17 años | 20 | 10 |

------------------------------------------------------------------------

### 1.2.3. Tipo de muestreo

El diseño es probabilístico, estratificado y trietápico, independiente en cada departamento.\
La selección de instituciones educativas se realiza sistemáticamente con probabilidad proporcional al tamaño (PPT) en la primera etapa, mientras que las secciones y los alumnos se eligen aleatoriamente en las etapas siguientes (segunda y tercera).

El estudio mantiene un nivel de confianza del 95 % y un efecto de diseño (DEFF) = 1.2.

### 1.2.4. Cálculo del tamaño muestral

La determinación del tamaño muestral se realizó aplicando la misma fórmula general:

$$
n = \frac{Z^2pqN}{d^2(N - 1) + Z^2pq} \times DEFF \times \frac{1}{(1 - TNR)}
$$

Para este dominio, se consideraron las prevalencias esperadas de violencia en el entorno escolar y familiar, así como las tasas esperadas de no respuesta en instituciones educativas.

**Tamaño final de muestra en instituciones educativas:**

| Tipo de encuesta | II.EE (total) | Alumnos (total) | Urbana (II.EE/alumnos) | Rural (II.EE/alumnos) |
|---------------|--------------:|--------------:|--------------:|--------------:|
| Niñas y niños 9–11 años (CRS.03) | 888 | 13,136 | 532 / 9,576 | 356 / 3,560 |
| Adolescentes 12–17 años (CRS.04) | 1,118 | 19,100 | 792 / 15,840 | 326 / 3,260 |

**Total nacional:** 2,006 instituciones educativas y 32,236 alumnos.

## 1.3. Síntesis del diseño muestral

El diseño muestral de la ENARES 2024 combina dos estrategias complementarias:\
- una encuesta en viviendas, de carácter probabilístico y multietápico, y\
- una encuesta en instituciones educativas, estructurada mediante muestreo trietápico estratificado.

Ambos esquemas garantizan la representatividad nacional, departamental y urbano–rural de los resultados.

# 2. Declaración del diseño muestral de la ENARES 2024

## 2.1. Declaración del diseño muestral – CRS.01 (Viviendas)

Para el módulo **CRS01_CAP100**, correspondiente a la Encuesta Nacional sobre Relaciones Sociales 2024 aplicada a mujeres de 18 años a más, se declara un diseño muestral complejo de tipo probabilístico, estratificado y multietápico.

En este diseño: - La **unidad primaria de muestreo (UPM)** corresponde al *conglomerado (`CONGLOME`)*.\
- El **estrato** se define combinando el *departamento (`CCDD`)* y el *tipo de área (`AREA`)*.\
- El **peso muestral** o **factor de expansión** está dado por la variable *`FACTOR_VIV`*.

A continuación, se presenta el procedimiento básico para declarar el diseño muestral en R usando el paquete `survey`.\
Incluye la importación de la base, la creación del estrato, la verificación y la declaración del diseño.

```{r}
# Cargar librerías necesarias
library(haven)
library(dplyr)
library(survey)
options(survey.lonely.psu = "adjust")

```

```{r}
# Importar la base CRS01_CAP100
ruta <- "C:/Users/FABIOLA/Downloads/ENARES/976-Modulo1941/976-Modulo1941/01_CRS01_CAP100.dta"
crs01 <- read_dta(ruta)
```

```{r}
# Crear variable de estrato
crs01 <- crs01 %>%
  mutate(
    ESTRATO = interaction(CCDD, AREA, drop = TRUE),
    CONGLOME = as.factor(CONGLOME),
    ESTRATO = as.factor(ESTRATO),
    FACTOR_VIV = as.numeric(FACTOR_VIV)
  )

# Declarar el diseño muestral
dis_crs01_cap100 <- svydesign(
  ids = ~CONGLOME,        # Unidad primaria (conglomerado)
  strata = ~ESTRATO,      # Estrato: Departamento × Área
  weights = ~FACTOR_VIV,  # Factor de expansión
  data = crs01,
  nest = TRUE
)
```

```{r}
# Resumen del diseño
summary(dis_crs01_cap100)

# Validación rápida
svytotal(~I(1), dis_crs01_cap100)    # Conteo expandido
svytable(~AREA, dis_crs01_cap100)    # Distribución por área
```

#### Ejemplo de estimación:

```{r}
# Ejemplo de estimación: viviendas con Internet
if("C1P110_4" %in% names(crs01)){
  internet_est <- svymean(~I(C1P110_4 == 1), design = dis_crs01_cap100, na.rm = TRUE)
  internet_est
  confint(internet_est)
}
```

## 2.2. Declaración del diseño muestral – CRS.01 (Mujeres)

En el módulo individual *CRS01_CAP300*, correspondiente a la Encuesta Nacional sobre Relaciones Sociales 2024 dirigida a mujeres de 18 años a más, cada observación representa a una persona entrevistada dentro de un hogar seleccionado.\
El diseño conserva la estructura jerárquica del muestreo por áreas y conglomerados, pero utiliza el **factor de expansión individual (`FACTOR_MUJ`)**, que permite obtener estimaciones representativas para la población femenina de 18 años a más, ajustadas por probabilidad de selección y tasa de no respuesta.

A continuación, se presenta la declaración del diseño muestral en **R**, utilizando el paquete `survey`:

```{r}
# Cargar librerías
library(haven)
library(survey)
library(dplyr)

# Cargar base de datos del módulo individual (nivel persona)
crs01_cap300 <- read_dta("C:/Users/FABIOLA/Downloads/ENARES/976-Modulo1943/976-Modulo1943/03_CRS01_CAP300.dta")

# Crear variable de estrato (departamento + área)
crs01_cap300 <- crs01_cap300 %>%
  mutate(
    ESTRATO = interaction(CCDD, AREA, drop = TRUE),
    CONGLOME = as.factor(CONGLOME),
    ESTRATO = as.factor(ESTRATO),
    FACTOR_MUJ = as.numeric(FACTOR_MUJ)
  )

# Declarar el diseño muestral
dis_crs01_cap300 <- svydesign(
  ids = ~CONGLOME,
  strata = ~ESTRATO,
  weights = ~FACTOR_MUJ,
  data = crs01_cap300,
  nest = TRUE
)

# Verificar estructura del diseño
dis_crs01_cap300

```

```{r}
# Conteo expandido (total de mujeres representadas)
svytotal(~I(1), dis_crs01_cap300)

```

#### Ejemplo de estimación:

```{r}
# Ejemplo: proporción de mujeres que están actualmente unidas (C1P302 == 2)
union_est <- svymean(~I(C1P302 == 2), design = dis_crs01_cap300, na.rm = TRUE)
union_est
confint(union_est)

```

## 2.3. Declaración del diseño muestral – CRS.02 (Viviendas)

La encuesta **CRS.02**, dirigida a hombres y mujeres de 18 años a más, mantiene el mismo esquema muestral que la CRS.01.

```{r}
# Cargar librerías
library(haven)
library(survey)

# Importar la base CRS01_CAP100
ruta3 <- "C:/Users/FABIOLA/Downloads/ENARES/976-Modulo1951/976-Modulo1951/11_CRS02_CAP100.dta"

crs02 <- read_dta(ruta3)

# Declarar diseño muestral
dis_crs02 <- svydesign(
  ids = ~CONGLOME,
  strata = ~AREA,
  weights = ~FACTOR_VIV,
  data = crs02,
  nest = TRUE
)

# Ver resumen del diseño
summary(dis_crs02) 

```

```{r}
# Conteo expandido total
svytotal(~I(1), dis_crs02)
```

#### Ejemplo de estimación:

```{r}

# Proporción de hogares con Internet
if("C1P110_4" %in% names(crs02)){
  internet_est <- svymean(~I(C1P110_4 == 1), design = dis_crs02, na.rm = TRUE)
  internet_est
  confint(internet_est)
}

```

## 2.4. Declaración del diseño muestral – CRS.02 (Hombres y mujeres de 18 años a más)

La encuesta **CRS.02** de la ENARES 2024 sigue el mismo esquema probabilístico y multietápico que la aplicada a mujeres (CRS.01). Su propósito es recoger información sobre experiencias y percepciones de violencia en hombres y mujeres de 18 años a más, garantizando representatividad nacional, departamental y por área urbana/rural.

```{r}
# Cargar librerías
library(haven)
library(survey)
library(dplyr)

# Cargar base de datos CRS.02 (Hombres y mujeres 18+)
crs02 <- read_dta("C:/Users/FABIOLA/Downloads/ENARES/976-Modulo1953//976-Modulo1953/13_CRS02_CAP300.dta")

# Declaración del diseño muestral
dis_crs02 <- svydesign(
  ids = ~CONGLOME,       # UPM
  strata = ~AREA,         # Estrato: urbano / rural
  weights = ~FACTOR_HYM,  # Factor de expansión individual
  data = crs02,
  nest = TRUE
)

# Resumen del diseño
summary(dis_crs02)
```

#### Ejemplo de estimación:

```{r}
# Proporción de personas casadas o convivientes
casados <- svymean(~I(C1P302 %in% c(1, 2)), design = dis_crs02, na.rm = TRUE)
casados
confint(casados)

```

## 2.5. Declaración del diseño muestral – CRS.03 (Niños de 9 a 11 años)

Está dirigida a niñas y niños de 9 a 11 años matriculados en los niveles 4.º, 5.º y 6.º de primaria de instituciones educativas públicas y privadas.

```{r}
# Cargar paquetes
library(haven)
library(survey)

# Cargar base CRS03 (niñas y niños 9–11 años)
crs03 <- read_dta("C:/Users/FABIOLA/Downloads/ENARES/976-Modulo1956//976-Modulo1956/16_CRS03_CAP100.dta")

# Crear variable de estrato combinando área y departamento
crs03$ESTRATO <- interaction(crs03$AREA, crs03$CCDD, drop = TRUE)

# Declarar el diseño muestral
dis_crs03_cap100 <- svydesign(
  ids = ~INED,             # Institución educativa como conglomerado (UPM)
  strata = ~ESTRATO,       # Estratificación por área y departamento
  weights = ~FACTOR_ALUMNOS,
  data = crs03,
  nest = TRUE
)

# Ver resumen del diseño
summary(dis_crs03_cap100)
```

## 2.5. Declaración del diseño muestral – CRS.04 (adolescentes 12 a 17 años )

Está dirigida a adolescentes de 12 a 17 años que cursan educación secundaria.

```{r}
# --- Cargar librerías ---
library(haven)
library(survey)

# --- Cargar base CRS.04 ---
crs04 <- read_dta("C:/Users/FABIOLA/Downloads/ENARES/976-Modulo1959//976-Modulo1959/19_CRS04_CAP100.dta")

# --- Crear variable de estrato ---
crs04$ESTRATO <- interaction(crs04$AREA, crs04$CCDD, drop = TRUE)

# --- Declarar diseño muestral ---
dis_crs04 <- svydesign(
  ids = ~INED,               # UPM = institución educativa
  strata = ~ESTRATO,         # estrato = área + departamento
  weights = ~FACTOR_ALUMNOS, # ponderador
  data = crs04,
  nest = TRUE
)

# --- Verificar diseño ---
summary(dis_crs04)

```

#### Ejemplo de estimación:

```{r}
# --- Ejemplo: proporción de estudiantes que declaran discusiones familiares (C3P123 == 1) ---
if ("C3P123" %in% names(crs04)) {
  disc_fam <- svymean(~I(C3P123 == 1), design = dis_crs04, na.rm = TRUE)
  disc_fam
  confint(disc_fam)
}
```

# Parte IV

Responda, en no más de 500 palabras, cada una de las siguientes preguntas.

## **Pregunta 1**

En el Ministerio de Desarrollo le han encargado a usted como muestrista principal diseñar una encuesta probabilística para medir la prevalencia de vulnerabilidad a la pobreza (variable dicotómica) en todas las regiones del Perú.

Su supervisor, quien es un muy buen *policymaker* –pero sin ninguna formación cuantitativa ni de muestreo– se enteró sobre el libro de Dillman (2014) y las tablas de cálculo de tamaño de muestra. Él le solicita que justifique sus decisiones metodológicas pues argumenta que “como máximo se necesitaría una muestra de tamaño *n=1067* como se observa en la figura 3.5 de libro”.

Usted ha planteado que se levante un muestreo complejo (estratificado y biétapico) para lograr el objetivo. Explique en un lenguaje **sencillo y de forma intuitiva** por qué necesitaría (o no) una muestra de mayor tamaño. Incluya en su respuesta el concepto de tamaño de muestra efectivo, correlación intracluster y efecto de diseño. Recuerde que su supervisor no maneja estos temas.

------------------------------------------------------------------------

Se necesitaría una muestra de mayor tamaño porque el diseño propuesto un *muestreo complejo, estratificado y bietápico* es menos eficiente estadísticamente que un muestreo aleatorio simple. En un muestreo aleatorio simple, cada individuo tiene la misma probabilidad de ser seleccionado y las observaciones son completamente independientes entre sí, lo que maximiza la información que aporta cada entrevista. Sin embargo, cuando las entrevistas se realizan dentro de conglomerados o zonas geográficas específicas, como distritos o manzanas, parte de esa independencia se pierde, lo que obliga a aumentar el tamaño de la muestra para mantener el mismo nivel de precisión.

Esta pérdida de independencia se explica por la correlación intraclúster, que refleja la similitud entre las personas que viven en un mismo conglomerado. En el caso de la vulnerabilidad a la pobreza, los hogares de una misma comunidad tienden a compartir características sociales y económicas, por lo que sus respuestas se parecen entre sí. En consecuencia, las entrevistas dentro de un mismo conglomerado aportan información parcialmente repetida. Dicho de forma sencilla, diez entrevistas realizadas en una sola comunidad no proporcionan tanta información nueva como diez entrevistas distribuidas en distintas regiones.

Esa reducción de la información útil tiene un efecto directo sobre la precisión de las estimaciones. En estadística, este fenómeno se mide mediante el efecto de diseño (deff), que indica cuánto se incrementa la varianza de los resultados debido al tipo de muestreo empleado. Si el diseño fuera igual de eficiente que un muestreo aleatorio simple, el *deff* sería 1.0. En la práctica, los diseños bietápicos suelen tener un *deff* entre 1.5 y 2.0, dependiendo del grado de homogeneidad de los conglomerados y del número de entrevistas realizadas en cada uno. Cuanto mayor sea el *deff*, mayor deberá ser el tamaño de muestra para lograr la misma precisión que bajo un muestreo aleatorio simple.

Este ajuste se refleja en el concepto de tamaño de muestra efectivo, que corresponde al número de entrevistas que, bajo un muestreo aleatorio simple, producirían una precisión equivalente a la del diseño complejo. Cuando se emplea un muestreo con conglomerados, el tamaño de muestra real debe ser mayor que el tamaño de muestra efectivo, siguiendo la relación:

$$
n_{real} = n_{efectivo} \times deff
$$

Si el tamaño de muestra efectivo fuese de 1.067 casos y el *deff* adoptado alcanzara un valor de 2.0, el tamaño de muestra real necesario sería cercano a 2134 entrevistas para conservar el mismo nivel de precisión.

En conclusion, se requiere una muestra de mayor tamaño porque el diseño bietápico genera correlación entre las observaciones, lo que disminuye la eficiencia del muestreo y aumenta la varianza de las estimaciones. El incremento del tamaño de muestra permite compensar esa pérdida de eficiencia y garantiza resultados estadísticamente confiables y representativos para todas las regiones del país.

## **Pregunta 2**

Un policymaker que cuenta con conocimientos intermedios de estadística le pide que utilice la Encuesta Nacional Agropecuaria más reciente para obtener estadísticas distritales de acceso a asistencia técnica en agricultores de Ayacucho. Estos datos serán utilizados en el diseño de un programa público de apoyo a los productores. Explique al funcionario si esto es posible y por qué. Considere en su respuesta mencionar qué tipo de técnicas, modelos y bases de datos adicionales se podrían utilizar para obtener estimaciones en estos dominios menores (distritos).

------------------------------------------------------------------------

La Encuesta Nacional Agropecuaria (ENA) ha sido diseñada para generar estimaciones a nivel nacional y departamental, lo que dificulta obtener estadísticas confiables a un nivel menor para el que ha sido diseñado, como el distrital. Esto se debe a que la muestra de la ENA se selecciona de manera sistematica en cada departamento, a partir de un punto de inicio aleatorio. Este diseño ocaciona que varios distritos carezcan de cobertura muestral suficiente, lo que se traduce en estimaciones con altos coeficientes de variación, o en la imposibilidad de generar estimaciones debido a la ausencia total de cobertura muestral en el distrito.

El código de linas abajo estima, a partir de la ENA 2024, la proporción de productores agropecuarios que recibieron asistencia técnica en los últimos tres años, a nivel departamental. Los resultados muestran un estimado con coeficiente de variación de 9.8% para Ayacucho, sin embargo varios departamentos presentan coeficientes de variación superiores al 15%, lo que evidencia que incluso a nivel departamental existen estimaciones con baja precisión estadística. Asimismo, según la ENA 2024, de los 109 distritos del departamento de Ayacucho, solo 11 cuentan con unidades muestrales seleccionadas, lo que refuerza la falta de representatividad a nivel distrital y la imposibilidad de obtener estadisticas distritales a partir de la ENA 2024.

Frente a esta limitación, se pueden emplear las siguientes técnicas para su solución.

1.  Desde el enfoque del diseño muestral, se plantea la posibilidad de sobremuestrear el departamento de ayacucho a fin de alcanzar un nivel de inferencia válido para sus distritos, sin embargo, esto implica el incremento de los costos de recolección de datos.

2.  Otra alternativa más eficiente corresponde a las técnicas de estimación en áreas menores (Small Area Estimation, SAE**)** que integran el enfoque basado en el diseño y el modelo. Para nuestro objetivo distinguiremos principalmente dos tipos de modelos:

    -   **Modelos a nivel de área**: permiten estimar directamente la proporción de agricultores con acceso a asistencia técnica a nivel distrital. Un enfoque adecuado es el modelo binomial logit normal (BLN), dado que la variable de interés es una proporción. La implementación de este tipo de modelos requiere variables auxiliares disponibles a nivel distrital, que pueden provenir de la información estadistica agrícola del MIDAGRI; los registros administrativos de SENASA o programas de extensión agraria.

    -   **Modelos a nivel de unidad**: permiten estimar la probabilidad de que cada productor haya recibido asistencia técnica. Un modelo comúnmente empleado es el de modelos lineales generalizados mixtos (GLMM), adecuado para variables binarias. En este caso, se requiere información a nivel productor, cuyas variables auxiliares pueden obtenerse del censo nacional agropecuario (CENAGRO 2012), que provee información estructural sobre productores, cultivos y acceso a asistencia técnica; el censo nacionales de población y vivienda (2017), que aportan variables socioeconómicas y demograficas relevantes de cada individuo. Además, el MIDAGRI cuenta con el padrón de productores agrarios que contiene información sobre politicas sectoriales que buca el crecimiento del productor, la cual puede proveer variables clave para fortalecer el modelo.

```{r}
library(survey)
library(tidyverse)
library(haven)

setwd('D:/CURSOS/CURSO INEI/PEU CD INEI/4_Metodos de estimacion estadistica/Tarea/973-Modulo1907')

df <-read_dta('15_CAP700.dta') 

# Filtro de productores agropecuarios - persona natural
df_persona <- df |> 
  filter(CODIGO==1)

# Variable categorica (P701)
# EN LOS ÚLTIMOS 3 AÑOS, DE ……………… A………………, ¿UD. HA RECIBIDO CAPACITACIÓN?

df_persona$capacitacion <- ifelse(df_persona$P701==1,1,0)

# Para modificar el error de un estrato con una sola PSU
options(survey.lonely.psu = "certainty")

# Diseño muestral
diseño <- svydesign(
  id = ~NSEGM,                 # identificador del segmento (PSU)
  strata = ~ESTRATO,           # variable de estratificación
  weights = ~FACTOR_PRODUCTOR, # factor de expansión
  data = df_persona,
  nest = TRUE
)

# Proporción de agricultores capacitados por departamento
res <- svyby(~capacitacion, ~NOMBREDD, diseño, svymean, na.rm = TRUE)
res |> 
  mutate(capacitacion=round(capacitacion*100,2),
         cv=round((res$se / res$capacitacion) * 100,2))
```
